name: API CI
on: [push]
jobs:
  test:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9
      - run: python -m venv venv && . venv/bin/activate && pip install -r requirements.txt
      - name: Start mock-api
        run: docker build -t mock-api mock-server && docker run -d -p 5000:5000 mock-api
      - name: Wait for mock-api
        run: |
          for i in {1..10}; do
            if nc -z localhost 5000; then
              echo "Mock API is up!";
              break;
            fi;
            echo "Waiting for Mock API...";
            sleep 3;
          done
      - run: . venv/bin/activate && PYTHONPATH=$(pwd) pytest -q --maxfail=1 --showlocals
      - name: Upload pytest results
        if: always()
        run: echo "Reports available"
      - name: Run tests with HTML report
        run: pytest -q --maxfail=1 --html=report.html --self-contained-html    
      - name: Upload PyTest HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: pytest-html-report
          path: report.html  # Matches the file generated above